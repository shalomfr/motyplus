generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== משתמשי מערכת =====

enum UserRole {
  ADMIN
  AGENT
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(ADMIN)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  accounts        Account[]
  sessions        Session[]
  customerUpdates CustomerUpdate[]
  emailLogs       EmailLog[]
  leadNotes       LeadNote[]
  assignedLeads   Lead[]        @relation("AssignedAgent")
  activityLogs    ActivityLog[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ===== לקוחות =====

enum CustomerStatus {
  ACTIVE
  BLOCKED
  FROZEN
  EXCEPTION
}

enum SampleType {
  CPI
  CPF
}

model Customer {
  id                   Int            @id @default(autoincrement())
  fullName             String
  phone                String
  whatsappPhone        String?
  address              String?
  email                String
  purchaseDate         DateTime       @default(now())
  updateExpiryDate     DateTime
  organId              String
  additionalOrganId    String?
  setTypeId            String
  amountPaid           Decimal        @db.Decimal(10, 2)
  status               CustomerStatus @default(ACTIVE)
  sampleType           SampleType     @default(CPI)
  currentUpdateVersion String?
  hasV3                Boolean        @default(false)
  notes                String?        @db.Text
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  // Linked customer (additional organ)
  linkedCustomerId Int?
  linkedCustomer   Customer?  @relation("LinkedCustomers", fields: [linkedCustomerId], references: [id])
  linkedFrom       Customer[] @relation("LinkedCustomers")

  // Relations
  organ            Organ            @relation(fields: [organId], references: [id])
  additionalOrgan  Organ?           @relation("AdditionalOrgan", fields: [additionalOrganId], references: [id])
  setType          SetType          @relation(fields: [setTypeId], references: [id])
  customerUpdates  CustomerUpdate[]
  payments         Payment[]
  emailLogs        EmailLog[]
  convertedFromLead Lead?           @relation("ConvertedLead")
  activityLogs     ActivityLog[]    @relation("CustomerActivity")

  @@index([organId])
  @@index([setTypeId])
  @@index([status])
  @@index([email])
  @@index([fullName])
}

// ===== נתוני בסיס =====

model Organ {
  id              String  @id @default(cuid())
  name            String  @unique
  supportsUpdates Boolean @default(false)
  sortOrder       Int     @default(0)
  isActive        Boolean @default(true)

  // Relations
  customers           Customer[]
  additionalCustomers Customer[] @relation("AdditionalOrgan")
  leads               Lead[]
}

model SetType {
  id              String  @id @default(cuid())
  name            String  @unique
  price           Decimal @db.Decimal(10, 2)
  includesUpdates Boolean @default(false)
  sortOrder       Int     @default(0)
  isActive        Boolean @default(true)

  // Relations
  customers Customer[]
}

// ===== עדכונים =====

enum UpdateVersionStatus {
  DRAFT
  PREPARING
  READY
  SENDING
  COMPLETED
}

model UpdateVersion {
  id                 String              @id @default(cuid())
  version            String              @unique
  price              Decimal             @db.Decimal(10, 2)
  releaseDate        DateTime?
  description        String?             @db.Text
  status             UpdateVersionStatus @default(DRAFT)
  driveRhythmsFolder String?
  driveSamplesFolder String?
  emailSubject       String?
  emailBody          String?             @db.Text
  sortOrder          Int                 @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  // Relations
  customerUpdates CustomerUpdate[]
}

model CustomerUpdate {
  id              String    @id @default(cuid())
  customerId      Int
  updateVersionId String
  sentAt          DateTime?
  downloadedAt    DateTime?
  sentById        String?
  robotProcessed  Boolean   @default(false)
  robotError      String?
  createdAt       DateTime  @default(now())

  // Relations
  customer      Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  updateVersion UpdateVersion @relation(fields: [updateVersionId], references: [id])
  sentBy        User?         @relation(fields: [sentById], references: [id])

  @@unique([customerId, updateVersionId])
  @@index([customerId])
  @@index([updateVersionId])
}

// ===== לידים =====

enum LeadStage {
  NEW
  CONTACTED
  PROPOSAL
  CLOSED_WON
  CLOSED_LOST
}

model Lead {
  id                  String    @id @default(cuid())
  fullName            String
  phone               String
  email               String?
  organInterest       String?
  organId             String?
  source              String?
  stage               LeadStage @default(NEW)
  assignedAgentId     String?
  convertedCustomerId Int?      @unique
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  organ             Organ?     @relation(fields: [organId], references: [id])
  assignedAgent     User?      @relation("AssignedAgent", fields: [assignedAgentId], references: [id])
  convertedCustomer Customer?  @relation("ConvertedLead", fields: [convertedCustomerId], references: [id])
  notes             LeadNote[]
  emailLogs         EmailLog[]

  @@index([stage])
  @@index([assignedAgentId])
}

model LeadNote {
  id        String   @id @default(cuid())
  leadId    String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([leadId])
}

// ===== מיילים =====

enum EmailStatus {
  DRAFT
  SENT
  FAILED
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  body      String   @db.Text
  category  String?
  variables String[] // Dynamic variable names used
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  emailLogs EmailLog[]
}

model EmailLog {
  id         String      @id @default(cuid())
  customerId Int?
  leadId     String?
  templateId String?
  toEmail    String
  subject    String
  body       String      @db.Text
  status     EmailStatus @default(DRAFT)
  sentAt     DateTime?
  userId     String?

  // Relations
  customer Customer?      @relation(fields: [customerId], references: [id])
  lead     Lead?          @relation(fields: [leadId], references: [id])
  template EmailTemplate? @relation(fields: [templateId], references: [id])
  user     User?          @relation(fields: [userId], references: [id])

  @@index([customerId])
  @@index([leadId])
  @@index([status])
}

// ===== מבצעים =====

model Promotion {
  id              String    @id @default(cuid())
  name            String
  discountPercent Int
  couponCode      String    @unique
  validFrom       DateTime
  validUntil      DateTime
  isActive        Boolean   @default(true)
  maxUses         Int?
  currentUses     Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  payments Payment[]
}

// ===== תשלומים =====

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id                String        @id @default(cuid())
  customerId        Int
  amount            Decimal       @db.Decimal(10, 2)
  description       String?
  status            PaymentStatus @default(PENDING)
  paymentMethod     String?
  externalPaymentId String?
  promotionId       String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  customer  Customer   @relation(fields: [customerId], references: [id])
  promotion Promotion? @relation(fields: [promotionId], references: [id])

  @@index([customerId])
  @@index([status])
}

// ===== יומן פעילות =====

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  customerId Int?
  action     String
  entityType String
  entityId   String
  details    Json?
  createdAt  DateTime @default(now())

  // Relations
  user     User?     @relation(fields: [userId], references: [id])
  customer Customer? @relation("CustomerActivity", fields: [customerId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([customerId])
  @@index([createdAt])
}

// ===== הגדרות מערכת =====

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt
}
